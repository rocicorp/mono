import {mergeConfig} from 'vitest/config';
import config, {CI} from '../shared/src/tool/vitest-config.ts';

/**
 * Vitest config for zero-server pentest suite.
 *
 * Uses PostgreSQL 16 (same as vitest.config.pg-16.ts) with longer timeouts
 * to accommodate security testing scenarios.
 */
const merged = mergeConfig(config, {
  test: {
    name: 'zero-server/pentest',
    browser: {enabled: false},
    silent: 'passed-only',
    globalSetup: ['../zero-cache/test/pg-16.ts'],
    testTimeout: 120000, // Pentests may need longer for attack scenarios
    hookTimeout: 30000,
    pool: 'forks', // Isolated processes for security tests
    poolOptions: {
      forks: {
        singleFork: true, // Run tests sequentially (shared DB state)
      },
    },
    coverage: {
      enabled: !CI,
      reporter: [['html'], ['clover', {file: 'coverage.xml'}]],
      include: ['src/**'],
      exclude: ['**/*.yml', '**/*.yaml'],
    },
  },
});

// Override include to only pentest files (mergeConfig merges arrays, we want to replace)
merged.test.include = ['src/pentest/**/*.pentest.ts'];
merged.test.exclude = [];

export default merged;
