import type {NetworkInterfaceInfo} from 'node:os';
import {expect, test} from 'vitest';
import {getPreferredIp} from './network.ts';

test.each([
  [
    'macbook',
    '192.168.2.181',
    [],
    {
      lo0: [
        {
          address: '127.0.0.1',
          netmask: '255.0.0.0',
          family: 'IPv4',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '127.0.0.1/8',
        },
        {
          address: '::1',
          netmask: 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff',
          family: 'IPv6',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '::1/128',
          scopeid: 0,
        },
        {
          address: 'fe80::1',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: 'fe80::1/64',
          scopeid: 1,
        },
      ],
      ap1: [
        {
          address: 'fe80::603e:5fff:fe3c:6cc4',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: 'f4:b7:b3:a4:c9:f1',
          internal: false,
          cidr: 'fe80::603e:5fff:fe3c:6cc4/64',
          scopeid: 14,
        },
      ],
      en0: [
        {
          address: 'fe80::143b:1ab5:b258:e29c',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: 'ef:e8:c3:87:f7:54',
          internal: false,
          cidr: 'fe80::143b:1ab5:b258:e29c/64',
          scopeid: 15,
        },
        {
          address: '192.168.2.181',
          netmask: '255.255.255.0',
          family: 'IPv4',
          mac: 'ef:e8:c3:87:f7:5',
          internal: false,
          cidr: '192.168.2.181/24',
        },
        {
          address: 'fd16:dbc3:9d33:1bac:18dd:d8bf:3f1d:ad60',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: 'ef:e8:c3:87:f7:5',
          internal: false,
          cidr: 'fd16:dbc3:9d33:1bac:18dd:d8bf:3f1d:ad60/64',
          scopeid: 0,
        },
      ],
      awdl0: [
        {
          address: 'fe80::c87a:a6ff:fe5c:fa11',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: 'e9:50:ab:1a:dd:16',
          internal: false,
          cidr: 'fe80::c87a:a6ff:fe5c:fa11/64',
          scopeid: 16,
        },
      ],
      llw0: [
        {
          address: 'fe80::c87a:a6ff:fe5c:fa11',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: 'ca:7a:a6:5c:fa:11',
          internal: false,
          cidr: 'fe80::c87a:a6ff:fe5c:fa11/64',
          scopeid: 17,
        },
      ],
      utun0: [
        {
          address: 'fe80::83c8:5e05:ec0c:affc',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: '00:00:00:00:00:00',
          internal: false,
          cidr: 'fe80::83c8:5e05:ec0c:affc/64',
          scopeid: 18,
        },
      ],
    },
  ],
  [
    'macbook with VPN',
    '192.168.3.81',
    ['eth', 'en'],
    {
      lo0: [
        {
          address: '127.0.0.1',
          netmask: '255.0.0.0',
          family: 'IPv4',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '127.0.0.1/8',
        },
        {
          address: '::1',
          netmask: 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff',
          family: 'IPv6',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '::1/128',
          scopeid: 0,
        },
        {
          address: 'fe80::1',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: 'fe80::1/64',
          scopeid: 1,
        },
      ],
      ap1: [
        {
          address: 'fe80::603e:5fff:fe3c:6cc4',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: 'f4:b7:b3:a4:c9:f1',
          internal: false,
          cidr: 'fe80::603e:5fff:fe3c:6cc4/64',
          scopeid: 14,
        },
      ],
      en0: [
        {
          address: 'fe80::143b:1ab5:b258:e29c',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: 'ef:e8:c3:87:f7:54',
          internal: false,
          cidr: 'fe80::143b:1ab5:b258:e29c/64',
          scopeid: 15,
        },
        {
          address: '192.168.3.81',
          netmask: '255.255.255.0',
          family: 'IPv4',
          mac: 'ef:e8:c3:87:f7:5',
          internal: false,
          cidr: '192.168.3.81/24',
        },
        {
          address: 'fd16:dbc3:9d33:1bac:18dd:d8bf:3f1d:ad60',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: 'ef:e8:c3:87:f7:5',
          internal: false,
          cidr: 'fd16:dbc3:9d33:1bac:18dd:d8bf:3f1d:ad60/64',
          scopeid: 0,
        },
      ],
      awdl0: [
        {
          address: 'fe80::c87a:a6ff:fe5c:fa11',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: 'e9:50:ab:1a:dd:16',
          internal: false,
          cidr: 'fe80::c87a:a6ff:fe5c:fa11/64',
          scopeid: 16,
        },
      ],
      llw0: [
        {
          address: 'fe80::c87a:a6ff:fe5c:fa11',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: 'ca:7a:a6:5c:fa:11',
          internal: false,
          cidr: 'fe80::c87a:a6ff:fe5c:fa11/64',
          scopeid: 17,
        },
      ],
      utun0: [
        {
          address: '10.1.2.3',
          netmask: '255.255.255.0',
          family: 'IPv4',
          mac: 'a4:cf:c0:3a:b0:3f',
          internal: false,
          cidr: '10.1.2.0/24',
        },
      ],
    },
  ],
  [
    'fly',
    '172.19.1.114',
    ['eth', 'en'],
    {
      lo: [
        {
          address: '127.0.0.1',
          netmask: '255.0.0.0',
          family: 'IPv4',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '127.0.0.1/8',
        },
        {
          address: '::1',
          netmask: 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff',
          family: 'IPv6',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '::1/128',
          scopeid: 0,
        },
      ],
      eth0: [
        {
          address: '172.19.1.114',
          netmask: '255.255.255.248',
          family: 'IPv4',
          mac: '41:06:c1:4f:c1:d3',
          internal: false,
          cidr: '172.19.1.114/29',
        },
        {
          address: '172.19.1.115',
          netmask: '255.255.255.248',
          family: 'IPv4',
          mac: '41:06:c1:4f:c1:d3',
          internal: false,
          cidr: '172.19.1.115/29',
        },
        {
          address: '2605:4c40:104:c6d5:0:c8e8:6899:1',
          netmask: 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:fffe',
          family: 'IPv6',
          mac: '41:06:c1:4f:c1:d3',
          internal: false,
          cidr: '2605:4c40:104:c6d5:0:c8e8:6899:1/127',
          scopeid: 0,
        },
        {
          address: 'fdaa:b:e473:a7b:7d18:c8e8:6899:2',
          netmask: 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:0',
          family: 'IPv6',
          mac: '41:06:c1:4f:c1:d3',
          internal: false,
          cidr: 'fdaa:b:e473:a7b:7d18:c8e8:6899:2/112',
          scopeid: 0,
        },
        {
          address: 'fe80::dcad:15ff:fef1:100',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: '41:06:c1:4f:c1:d3',
          internal: false,
          cidr: 'fe80::dcad:15ff:fef1:100/64',
          scopeid: 3,
        },
      ],
    },
  ],
  [
    'awsvpc',
    '10.0.0.227',
    ['eth', 'en'],
    {
      lo: [
        {
          address: '127.0.0.1',
          netmask: '255.0.0.0',
          family: 'IPv4',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '127.0.0.1/8',
        },
        {
          address: '::1',
          netmask: 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff',
          family: 'IPv6',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '::1/128',
          scopeid: 0,
        },
      ],
      eth0: [
        {
          address: '169.254.172.2',
          netmask: '255.255.252.0',
          family: 'IPv4',
          mac: '0a:58:a9:fe:ac:02',
          internal: false,
          cidr: '169.254.172.2/22',
        },
        {
          address: 'fe80::20bf:e9ff:feb9:2f5c',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: '0a:58:a9:fe:ac:02',
          internal: false,
          cidr: 'fe80::20bf:e9ff:feb9:2f5c/64',
          scopeid: 3,
        },
      ],
      eth1: [
        {
          address: '10.0.0.227',
          netmask: '255.255.252.0',
          family: 'IPv4',
          mac: '0a:ff:dc:f4:16:fd',
          internal: false,
          cidr: '10.0.0.227/22',
        },
        {
          address: 'fe80::8ff:dcff:fef4:16fd',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: '0a:ff:dc:f4:16:fd',
          internal: false,
          cidr: 'fe80::8ff:dcff:fef4:16fd/64',
          scopeid: 4,
        },
      ],
    },
  ],
  [
    'windows',
    '192.168.1.49',
    ['eth', 'en'],
    {
      ['Wi-Fi']: [
        {
          address: 'fd16:dbc3:9d33:1bac:ed78:12df:d80b:7eff',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: '97:ba:d3:29:e7:f3',
          internal: false,
          cidr: 'fd16:dbc3:9d33:1bac:ed78:12df:d80b:7eff/64',
          scopeid: 0,
        },
        {
          address: 'fe80::730f:34f6:ecaa:3bc8',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: '97:ba:d3:29:e7:f3',
          internal: false,
          cidr: 'fe80:730f:34f6:ecaa:3bc8/64',
          scopeid: 17,
        },
        {
          address: '192.168.1.49',
          netmask: '255.255.255.0',
          family: 'IPv4',
          mac: '97:ba:d3:29:e7:f3',
          internal: false,
          cidr: '192.168.1.49/24',
        },
      ],
      ['Loopback Pseudo-Interface 1']: [
        {
          address: '::1',
          netmask: 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff',
          family: 'IPv6',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '::1/128',
          scopeid: 0,
        },
        {
          address: '127.0.0.1',
          netmask: '255.0.0.0',
          family: 'IPv4',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '127.0.0.1/8',
        },
      ],
    },
  ],
  [
    'explicit preference (a)',
    '4.3.2.1',
    ['en', 'eth'],
    {
      lo: [
        {
          address: '127.0.0.1',
          netmask: '255.0.0.0',
          family: 'IPv4',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '127.0.0.1/8',
        },
        {
          address: '::1',
          netmask: 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff',
          family: 'IPv6',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '::1/128',
          scopeid: 0,
        },
      ],
      en0: [
        {
          address: '4.3.2.1',
          netmask: '255.255.252.0',
          family: 'IPv4',
          mac: '0a:58:a9:fe:ac:02',
          internal: false,
          cidr: '4.3.2.1/22',
        },
        {
          address: 'fe80::20bf:e9ff:feb9:2f5c',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: '0a:58:a9:fe:ac:02',
          internal: false,
          cidr: 'fe80::20bf:e9ff:feb9:2f5c/64',
          scopeid: 3,
        },
      ],
      eth1: [
        {
          address: '1.2.3.4',
          netmask: '255.255.252.0',
          family: 'IPv4',
          mac: '0a:ff:dc:f4:16:fd',
          internal: false,
          cidr: '1.2.3.4/22',
        },
        {
          address: 'fe80::8ff:dcff:fef4:16fd',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: '0a:ff:dc:f4:16:fd',
          internal: false,
          cidr: 'fe80::8ff:dcff:fef4:16fd/64',
          scopeid: 4,
        },
      ],
    },
  ],
  [
    'explicit preference (b)',
    '1.2.3.4',
    ['eth', 'en'],
    {
      lo: [
        {
          address: '127.0.0.1',
          netmask: '255.0.0.0',
          family: 'IPv4',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '127.0.0.1/8',
        },
        {
          address: '::1',
          netmask: 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff',
          family: 'IPv6',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '::1/128',
          scopeid: 0,
        },
      ],
      en0: [
        {
          address: '4.3.2.1',
          netmask: '255.255.252.0',
          family: 'IPv4',
          mac: '0a:58:a9:fe:ac:02',
          internal: false,
          cidr: '4.3.2.1/22',
        },
        {
          address: 'fe80::20bf:e9ff:feb9:2f5c',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: '0a:58:a9:fe:ac:02',
          internal: false,
          cidr: 'fe80::20bf:e9ff:feb9:2f5c/64',
          scopeid: 3,
        },
      ],
      eth1: [
        {
          address: '1.2.3.4',
          netmask: '255.255.252.0',
          family: 'IPv4',
          mac: '0a:ff:dc:f4:16:fd',
          internal: false,
          cidr: '1.2.3.4/22',
        },
        {
          address: 'fe80::8ff:dcff:fef4:16fd',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: '0a:ff:dc:f4:16:fd',
          internal: false,
          cidr: 'fe80::8ff:dcff:fef4:16fd/64',
          scopeid: 4,
        },
      ],
    },
  ],
  [
    'ipv6',
    '[2605:4c40:104:c6d5:0:c8e8:6899:1]',
    ['eth', 'en'],
    {
      lo: [
        {
          address: '127.0.0.1',
          netmask: '255.0.0.0',
          family: 'IPv4',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '127.0.0.1/8',
        },
        {
          address: '::1',
          netmask: 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff',
          family: 'IPv6',
          mac: '00:00:00:00:00:00',
          internal: true,
          cidr: '::1/128',
          scopeid: 0,
        },
      ],
      eth0: [
        {
          address: '2605:4c40:104:c6d5:0:c8e8:6899:1',
          netmask: 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:fffe',
          family: 'IPv6',
          mac: '41:06:c1:4f:c1:d3',
          internal: false,
          cidr: '2605:4c40:104:c6d5:0:c8e8:6899:1/127',
          scopeid: 0,
        },
        {
          address: 'fdaa:b:e473:a7b:7d18:c8e8:6899:2',
          netmask: 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:0',
          family: 'IPv6',
          mac: '41:06:c1:4f:c1:d3',
          internal: false,
          cidr: 'fdaa:b:e473:a7b:7d18:c8e8:6899:2/112',
          scopeid: 0,
        },
        {
          address: 'fe80::dcad:15ff:fef1:100',
          netmask: 'ffff:ffff:ffff:ffff::',
          family: 'IPv6',
          mac: '41:06:c1:4f:c1:d3',
          internal: false,
          cidr: 'fe80::dcad:15ff:fef1:100/64',
          scopeid: 3,
        },
      ],
    },
  ],
  [
    'internal preferred over private',
    '127.0.0.1',
    ['eth', 'en'],
    {
      eth1: [
        {
          internal: false,
          family: 'IPv4',
          mac: '00:00:00:00:00:00',
          address: '169.254.8.1',
          netmask: '255.255.255.255',
          cidr: '169.254.8.1/32',
        },
        {
          mac: '00:00:00:00:00:00',
          netmask: 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff',
          address: 'fddf:3978:feb1:d745::c001',
          family: 'IPv6',
          cidr: 'fddf:3978:feb1:d745::c001/128',
          scopeid: 0,
          internal: false,
        },
      ],
      eth2: [
        {
          internal: false,
          cidr: '169.254.9.1/32',
          address: '169.254.9.1',
          netmask: '255.255.255.255',
          family: 'IPv4',
          mac: '42:00:4e:49:43:00',
        },
        {
          internal: false,
          cidr: '169.254.169.1/32',
          mac: '42:00:4e:49:43:00',
          address: '169.254.169.1',
          family: 'IPv4',
          netmask: '255.255.255.255',
        },
      ],
      lo: [
        {
          address: '127.0.0.1',
          netmask: '255.0.0.0',
          family: 'IPv4',
          internal: true,
          cidr: '127.0.0.1/8',
          mac: '00:00:00:00:00:00',
        },
        {
          internal: true,
          cidr: '::1/128',
          netmask: 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff',
          scopeid: 0,
          mac: '00:00:00:00:00:00',
          address: '::1',
          family: 'IPv6',
        },
      ],
    },
  ],
] satisfies [string, string, string[], NodeJS.Dict<NetworkInterfaceInfo[]>][])(
  '%s',
  (_name, preferred, prefixes, interfaces) => {
    expect(getPreferredIp(interfaces, prefixes)).toBe(preferred);
  },
);
