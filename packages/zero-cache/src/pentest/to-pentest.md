# Zero Cache Pentest Plan

Areas to explore with dynamic testing to find unknown vulnerabilities or verify uncertain findings from code review.

---

## Findings from Dynamic Testing

### Authentication Edge Cases (Tested 2026-01-16)

**Test file:** `src/pentest/auth-edge-cases.pentest.ts`

**Results:** 12/13 tests pass

| Test                             | Result | Notes                                                  |
| -------------------------------- | ------ | ------------------------------------------------------ |
| Malformed sec-websocket-protocol | PASS   | ws library rejects invalid protocols at client level   |
| Missing protocol header          | PASS   | Server correctly rejects                               |
| Malformed JWT tokens             | PASS   | All malformed variants rejected                        |
| Expired JWT                      | PASS   | Correctly rejected with close code 3000                |
| JWT with future nbf              | PASS   | Correctly rejected                                     |
| JWT with alg:none                | PASS   | Correctly rejected (jose library prevents this attack) |
| JWT subject mismatch             | PASS   | Correctly rejected                                     |
| JWT wrong signature              | PASS   | Correctly rejected                                     |
| No token with JWT config         | PASS   | Anonymous connection allowed                           |
| Token without JWT config         | PASS   | Error thrown (see finding below)                       |
| Empty string token               | PASS   | Handled correctly                                      |
| Connection reuse after expiry    | PASS   | Connection persists (expected - tokens validated once) |
| Invalid protocol version         | PASS   | Server rejects invalid version                         |

**Finding: Unhandled Error Path**

When a client sends a token but the server has no JWT config (and no custom endpoints), the server throws an unhandled error in `#createConnection` (syncer.ts:157). This causes an unhandled rejection rather than a graceful error response.

**Recommendation:** The error should be caught and sent to the client as an error message before closing the connection, rather than throwing an unhandled rejection.

---

## Verify Uncertain Findings

### ZSP-014: wsID Default Empty String (Status: Verify)

**Location:** `src/workers/connect-params.ts:47`

**Question:** Code shows `wsid` defaults to `''` when not provided. Can multiple connections share the same empty wsID, and does this cause security issues?

**Test approach:**

- [ ] Connect multiple clients without `wsid` parameter
- [ ] Verify whether messages can leak between connections
- [ ] Check if connection state becomes confused

---

## Exploratory Testing Areas

### 1. Authentication Edge Cases âœ… TESTED

**Goal:** Find edge cases in JWT/token handling not covered by static review.

**Status:** Tested (see Findings section above)

**Test approach:**

- [x] Malformed JWTs (truncated, wrong algorithm, expired edge cases)
- [x] Token parsing with unexpected characters/encoding
- [ ] Race conditions between token validation and request processing
- [x] Empty vs null vs missing token distinction
- [x] Tokens with unusual claims structures

### 2. Message Parsing Boundaries

**Goal:** Find parsing vulnerabilities through boundary testing.

**Test approach:**

- [ ] Type confusion in message handlers
- [ ] Integer overflow in size/count fields
- [ ] Unicode edge cases in identifiers (table names, column names)
- [ ] Deeply nested JSON structures
- [ ] Messages at exact size boundaries

### 3. Query Engine Fuzzing

**Goal:** Find SQL injection or logic bugs through malformed queries.

**Test approach:**

- [ ] Malformed AST structures that pass Valita validation but break execution
- [ ] Deep nesting / recursion in queries
- [ ] Edge cases in RLS condition generation
- [ ] Column/table names with special characters
- [ ] Values that look like SQL but should be escaped
- [ ] Subquery edge cases (oracle attack variations)

### 4. State Machine Bugs

**Goal:** Find race conditions and state confusion vulnerabilities.

**Test approach:**

- [ ] Out-of-order protocol messages
- [ ] Reconnection during active operations
- [ ] Concurrent mutations to same data
- [ ] Connection lifecycle edge cases (close during operation)
- [ ] Multiple rapid connect/disconnect cycles

### 5. Internal Query Bypass (ZSP-005 Verification)

**Goal:** Confirm clients cannot trigger `internalQuery: true` to bypass RLS.

**Location:** `src/services/view-syncer/cvr.ts:82-89`

**Test approach:**

- [ ] Attempt to inject `type: 'internal'` in query messages
- [ ] Try reserved query IDs (`lmids`, `mutationResults`)
- [ ] Fuzz query type determination logic

### 6. Custom Endpoint Security

**Goal:** Find SSRF or validation bypasses in custom mutation/query URLs.

**Location:** `src/custom/fetch.ts`

**Test approach:**

- [ ] URL parsing edge cases (unicode, encoding)
- [ ] DNS rebinding scenarios
- [ ] Response handling edge cases
- [ ] Timeout/retry abuse

---

## Test Priority

| Priority | Area                      | Rationale                              |
| -------- | ------------------------- | -------------------------------------- |
| 1        | Authentication Edge Cases | High impact, complex code path         |
| 2        | Query Engine Fuzzing      | SQL injection = critical if found      |
| 3        | ZSP-014 Verification      | Uncertain finding needs confirmation   |
| 4        | Internal Query Bypass     | RLS bypass = critical if possible      |
| 5        | State Machine Bugs        | Race conditions hard to find in review |
| 6        | Message Parsing           | Lower likelihood but worth exploring   |
| 7        | Custom Endpoint Security  | Depends on deployment configuration    |
