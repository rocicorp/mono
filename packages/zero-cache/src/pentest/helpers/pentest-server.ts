import {resolver} from '@rocicorp/resolver';
import {expect} from 'vitest';
import {randInt} from '../../../../shared/src/rand.ts';
import type {PermissionsConfig} from '../../../../zero-schema/src/compiled-permissions.ts';
import {getConnectionURI, type TestDBs} from '../../test/db.ts';
import {DbFile} from '../../test/lite.ts';
import type {PostgresDB} from '../../types/pg.ts';
import {childWorker} from '../../types/processes.ts';

export interface AuthOptions {
  /** Symmetric secret for HS256/HS384/HS512 JWT verification */
  secret?: string | undefined;
  /** JWK (JSON Web Key) for asymmetric JWT verification */
  jwk?: string | undefined;
  /** URL to fetch JWKS (JSON Web Key Set) */
  jwksUrl?: string | undefined;
}

/**
 * Schema mode for pentest server.
 * - 'minimal': Single table (pentest_data) with no permissions
 * - 'multi-permission': Multiple tables with different permission levels
 */
export type SchemaMode = 'minimal' | 'multi-permission';

export interface PentestServerOptions {
  adminPassword?: string | undefined;
  nodeEnv?: 'development' | 'production' | undefined;
  logLevel?: string | undefined;
  /** JWT authentication configuration */
  auth?: AuthOptions | undefined;
  /** Schema mode - 'minimal' or 'multi-permission' */
  schemaMode?: SchemaMode | undefined;
}

export interface PentestServer {
  /** Main HTTP port (sync, admin endpoints) */
  port: number;
  /** Replication HTTP port (change-streamer) - typically port + 1 */
  replicationPort: number;
  /** Clean shutdown - stops server and drops databases */
  cleanup: () => Promise<void>;
}

/**
 * Starts a zero-cache server for pentest/integration testing.
 *
 * Based on the pattern from integration.pg.test.ts:473-498.
 */
export async function startPentestServer(
  testDBs: TestDBs,
  options?: PentestServerOptions,
): Promise<PentestServer> {
  const port = randInt(5000, 16000);

  // Create test databases
  const upDB = await testDBs.create('pentest_upstream');
  const cvrDB = await testDBs.create('pentest_cvr');
  const changeDB = await testDBs.create('pentest_change');

  // Create SQLite replica file
  const replicaDbFile = new DbFile('pentest_replica');

  // Set up PostgreSQL schema based on mode
  const schemaMode = options?.schemaMode ?? 'minimal';
  if (schemaMode === 'multi-permission') {
    await setupMultiPermissionSchema(upDB);
  } else {
    await setupMinimalSchema(upDB);
  }

  // Start zero-cache server
  const {promise: ready, resolve: onReady} = resolver<unknown>();
  const {promise: done, resolve: onClose} = resolver<number>();

  // Enable single-process mode so childWorker runs in-process (required for tsx loader)
  process.env['SINGLE_PROCESS'] = '1';

  const env: Record<string, string> = {
    ZERO_PORT: String(port),
    ZERO_LOG_LEVEL: options?.logLevel ?? 'error',
    ZERO_UPSTREAM_DB: getConnectionURI(upDB),
    ZERO_UPSTREAM_MAX_CONNS: '3',
    ZERO_CVR_DB: getConnectionURI(cvrDB),
    ZERO_CVR_MAX_CONNS: '3',
    ZERO_APP_ID: 'pentest',
    ZERO_APP_PUBLICATIONS: 'zero_pentest',
    ZERO_CHANGE_DB: getConnectionURI(changeDB),
    ZERO_REPLICA_FILE: replicaDbFile.path,
    ZERO_NUM_SYNC_WORKERS: '1',
  };

  if (options?.adminPassword) {
    env.ZERO_ADMIN_PASSWORD = options.adminPassword;
  }

  if (options?.nodeEnv) {
    env.NODE_ENV = options.nodeEnv;
  }

  // Auth configuration
  if (options?.auth?.secret) {
    env.ZERO_AUTH_SECRET = options.auth.secret;
  }
  if (options?.auth?.jwk) {
    env.ZERO_AUTH_JWK = options.auth.jwk;
  }
  if (options?.auth?.jwksUrl) {
    env.ZERO_AUTH_JWKS_URL = options.auth.jwksUrl;
  }

  const zero = childWorker(
    new URL('../../server/runner/main.ts', import.meta.url),
    env,
  );
  zero.onMessageType('ready', onReady);
  zero.on('close', onClose);

  await ready;

  return {
    port,
    replicationPort: port + 1,
    cleanup: async () => {
      zero.kill('SIGTERM');
      const exitCode = await done;
      expect(exitCode).toBe(0);
      await testDBs.drop(upDB, cvrDB, changeDB);
      replicaDbFile.delete();
    },
  };
}

/**
 * Sets up minimal PostgreSQL schema required for zero-cache to start.
 */
async function setupMinimalSchema(db: PostgresDB): Promise<void> {
  await db.unsafe(`
    -- Minimal table for zero-cache to replicate
    CREATE TABLE pentest_data (
      id TEXT PRIMARY KEY,
      value TEXT
    );

    -- Publication for logical replication
    CREATE PUBLICATION zero_pentest FOR TABLE pentest_data;

    -- Permissions schema (required by zero-cache)
    CREATE SCHEMA IF NOT EXISTS "pentest";
    CREATE TABLE "pentest".permissions (
      permissions JSON,
      hash TEXT
    );
    INSERT INTO "pentest".permissions (permissions, hash)
    VALUES ('{}', '0');
  `);
}

/**
 * Permissions config for multi-permission schema.
 *
 * Tables:
 * - readable: ANYONE_CAN read (allows all users)
 * - writable: ANYONE_CAN read (for testing writes later)
 * - protected: Only admin role can read
 * - unreadable: No permissions (default deny)
 */
export const MULTI_PERMISSION_CONFIG: PermissionsConfig = {
  tables: {
    readable: {
      row: {
        // ANYONE_CAN read - allow with true condition (OR of empty is false, so use always-true)
        select: [
          [
            'allow',
            {
              type: 'simple',
              op: '=',
              left: {type: 'literal', value: 1},
              right: {type: 'literal', value: 1},
            },
          ],
        ],
      },
    },
    writable: {
      row: {
        // ANYONE_CAN read
        select: [
          [
            'allow',
            {
              type: 'simple',
              op: '=',
              left: {type: 'literal', value: 1},
              right: {type: 'literal', value: 1},
            },
          ],
        ],
      },
    },
    protected: {
      row: {
        // Only admin can read
        select: [
          [
            'allow',
            {
              type: 'simple',
              op: '=',
              left: {type: 'static', anchor: 'authData', field: 'role'},
              right: {type: 'literal', value: 'admin'},
            },
          ],
        ],
      },
    },
    // unreadable: no rules = default deny (all queries return empty)
  },
};

/**
 * Sets up PostgreSQL schema with multiple tables having different permission levels.
 * Used for testing RLS bypass attempts and permission edge cases.
 */
async function setupMultiPermissionSchema(db: PostgresDB): Promise<void> {
  await db.unsafe(`
    -- Table anyone can read
    CREATE TABLE readable (
      id TEXT PRIMARY KEY,
      value TEXT
    );
    INSERT INTO readable (id, value) VALUES
      ('r1', 'readable-value-1'),
      ('r2', 'readable-value-2');

    -- Table anyone can read (for write tests later)
    CREATE TABLE writable (
      id TEXT PRIMARY KEY,
      value TEXT
    );
    INSERT INTO writable (id, value) VALUES
      ('w1', 'writable-value-1'),
      ('w2', 'writable-value-2');

    -- Table only admin can read
    CREATE TABLE protected (
      id TEXT PRIMARY KEY,
      secret TEXT
    );
    INSERT INTO protected (id, secret) VALUES
      ('p1', 'admin-secret-1'),
      ('p2', 'admin-secret-2');

    -- Table with no read permissions (default deny)
    CREATE TABLE unreadable (
      id TEXT PRIMARY KEY,
      data TEXT
    );
    INSERT INTO unreadable (id, data) VALUES
      ('u1', 'hidden-data-1'),
      ('u2', 'hidden-data-2');

    -- Also include pentest_data for backwards compatibility
    CREATE TABLE pentest_data (
      id TEXT PRIMARY KEY,
      value TEXT
    );
    INSERT INTO pentest_data (id, value) VALUES
      ('d1', 'pentest-value-1'),
      ('d2', 'pentest-value-2');

    -- Publication for logical replication (all tables)
    CREATE PUBLICATION zero_pentest FOR TABLE
      readable, writable, protected, unreadable, pentest_data;

    -- Permissions schema with multi-permission config
    CREATE SCHEMA IF NOT EXISTS "pentest";
    CREATE TABLE "pentest".permissions (
      permissions JSON,
      hash TEXT
    );
    INSERT INTO "pentest".permissions (permissions, hash)
    VALUES ('${JSON.stringify(MULTI_PERMISSION_CONFIG).replace(/'/g, "''")}', '1');
  `);
}
