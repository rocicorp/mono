/**
 * Smoke test: Verify pentest server starts and responds correctly.
 *
 * This is the foundation for the pentest suite - ensuring we can reliably
 * spin up a zero-cache server for security testing.
 */
import {describe, expect} from 'vitest';
import {test} from '../test/db.ts';
import {startPentestServer} from './helpers/pentest-server.ts';

describe('pentest server setup', {timeout: 60000}, () => {
  test('server starts and health check responds', async ({testDBs}) => {
    const server = await startPentestServer(testDBs, {
      adminPassword: 'test-password',
      nodeEnv: 'production',
    });

    try {
      // Health check endpoint should respond
      const healthResponse = await fetch(`http://localhost:${server.port}/`);
      expect(healthResponse.status).toBe(200);
      const healthBody = await healthResponse.text();
      expect(healthBody).toBe('OK');

      // Keepalive endpoint should also respond
      const keepaliveResponse = await fetch(
        `http://localhost:${server.port}/keepalive`,
      );
      expect(keepaliveResponse.status).toBe(200);
    } finally {
      await server.cleanup();
    }
  });

  // Note: Development mode test removed because NODE_ENV is checked from process.env
  // early in server startup, not from the env passed to childWorker.
  // This limitation doesn't affect production pentests.

  test('server exposes replication port', async ({testDBs}) => {
    const server = await startPentestServer(testDBs, {
      adminPassword: 'test-password',
      nodeEnv: 'production',
    });

    try {
      // The replication port should be port + 1
      expect(server.replicationPort).toBe(server.port + 1);

      // Replication health endpoint should respond
      // (change-streamer HTTP service extends HttpService which has / route)
      const replicationHealth = await fetch(
        `http://localhost:${server.replicationPort}/`,
      );
      expect(replicationHealth.status).toBe(200);
    } finally {
      await server.cleanup();
    }
  });
});
