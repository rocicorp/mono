import {mergeConfig} from 'vitest/config';
import config, {CI} from '../shared/src/tool/vitest-config.ts';

/**
 * Vitest config for pentest suite.
 *
 * Uses PostgreSQL 16 (same as vitest.config.pg-16.ts) with longer timeouts
 * to accommodate server startup/shutdown.
 */
const merged = mergeConfig(config, {
  test: {
    name: 'zero-cache/pentest',
    browser: {enabled: false},
    silent: 'passed-only',
    globalSetup: ['./test/pg-16.ts'],
    testTimeout: 60000, // Pentests may need longer to start servers
    hookTimeout: 30000,
    pool: 'forks', // Isolated processes for server tests
    poolOptions: {
      forks: {
        singleFork: true, // Run tests sequentially (server resources)
      },
    },
    coverage: {
      enabled: !CI,
      reporter: [['html'], ['clover', {file: 'coverage.xml'}]],
      include: ['src/**'],
    },
  },
});

// Override include to only pentest files (mergeConfig merges arrays, we want to replace)
merged.test.include = ['src/pentest/**/*.pentest.ts'];
merged.test.exclude = [];

export default merged;
